
<p>
Lua скрипты в Remixed Pixel Dungeon.
</p>

<h1 class="sectionedit1" id="вступление">Вступление</h1>
<div class="level1">

<p>
Скрипты в rpd реализованы с помощью <a href="http://www.luaj.org/luaj/3.0/README.html" class="urlextern" title="http://www.luaj.org/luaj/3.0/README.html">luaj 3.0.1</a> - реализации языка <a href="https://www.lua.org/manual/5.2/" class="urlextern" title="https://www.lua.org/manual/5.2/">lua 5.2</a> в jvm.
</p>

<p>
Благодаря библиотеке luajava ( её реализации в luaj ) с помощью скриптов можно менять <strong>всё</strong>, однако такой  подход потребует хорошего знания java, lua и всей кодовой базы rpd, наша же цель сделать моддинг (процесс создания модов ) - максимально простым (насколько это возможно при разумных затратах времени на создание инструментов).
</p>

<p>
Общая структура скриптов в моде:
</p>
<ul>
<li class="level1 node"><div class="li"> корневая папка мода</div>
<ul>
<li class="level2 node"><div class="li"> scripts - корневая папка для скриптов</div>
<ul>
<li class="level3"><div class="li"> lib - библиотеки RPD и другие, как правило модам здесь менять ничего не нужно</div>
</li>
<li class="level3"><div class="li"> actors - тут лежат уже готовые акторы</div>
</li>
<li class="level3"><div class="li"> traps - тут лежат уже готовые ловушки</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Скрипты основных библиотек имеют имена файлов в camelCase, пользовательские же скрипты предпочтительно именовать в CamelCase.
</p>

<p>
Все файлы скриптов должны быть в кодировке UTF-8 без BOM.
</p>

<p>
Ниже последует описание некоторых уже реализованных возможностей скриптинга:
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u0412\u0441\u0442\u0443\u043f\u043b\u0435\u043d\u0438\u0435&quot;,&quot;hid&quot;:&quot;\u0432\u0441\u0442\u0443\u043f\u043b\u0435\u043d\u0438\u0435&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:1,&quot;range&quot;:&quot;47-1788&quot;} -->
<h1 class="sectionedit2" id="ловушки_они_же_триггеры">Ловушки (Они же триггеры)</h1>
<div class="level1">

<p>
Ловушка ( LevelObject - Trap ) объект, который активируется когда на него наступает герой (или моб, или падает предмет в зависимости от параметров). При активации Trap может имитировать поведение одной из базовых ловушек или выполнить скрипт.
</p>

<p>
На вход скрипт получает индекс клетки где должен сработать, существо, которое привело триггер в действие и строку указанную в описании ловушки.
</p>

<p>
Например так будет выглядеть описание триггера который просто покажет текст:
</p>
<pre class="code">{
&quot;kind&quot;:&quot;Trap&quot;,
&quot;x&quot;:9,
&quot;y&quot;:9,
&quot;uses&quot;:1,
&quot;trapKind&quot;:&quot;scriptFile&quot;,
&quot;script&quot;:&quot;scripts/TrapMessage&quot;,
&quot;data&quot;:&quot;This is test Message&quot;,
}</pre>

<p>
Посмотрите для примера на код файла <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/traps/Message.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/traps/Message.lua">scripts/traps/Message.lua</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u041b\u043e\u0432\u0443\u0448\u043a\u0438 (\u041e\u043d\u0438 \u0436\u0435 \u0442\u0440\u0438\u0433\u0433\u0435\u0440\u044b)&quot;,&quot;hid&quot;:&quot;\u043b\u043e\u0432\u0443\u0448\u043a\u0438_\u043e\u043d\u0438_\u0436\u0435_\u0442\u0440\u0438\u0433\u0433\u0435\u0440\u044b&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:2,&quot;range&quot;:&quot;1789-3038&quot;} -->
<h1 class="sectionedit3" id="акторы">Акторы</h1>
<div class="level1">

<p>
Актор - это такая бесплотная сущность которая существует на уровне и периодически что-то делает.
</p>

<p>
В отличие от ловушки актор может реализовывать 3 метода:
</p>
<ul>
<li class="level1"><div class="li"> act - собственно действие, метод возвращает true - если другие акторы ( в том числе и встроенные ) действовать или же им нужно ждать. </div>
</li>
<li class="level1"><div class="li"> actionTime - возвращает время через которое актор активируется ещё раз</div>
</li>
<li class="level1"><div class="li"> activate - выполняется один раз при добавлении актора на уровень</div>
</li>
</ul>

<p>
Актора можно подцепить к уровню в Dungeon.json например так:
</p>
<pre class="code">&quot;hotLevel&quot;:{&quot;kind&quot;:&quot;PredesignedLevel&quot;, &quot;depth&quot;:0, &quot;file&quot;:&quot;levelsDesc/TestLevelSewers.json&quot;,&quot;script&quot;:&quot;scripts/actors/Burn&quot;}

&quot;script&quot;:&quot;scripts/actors/Burn&quot;</pre>

<p>
Или же можно подцепить актора к уровню из любого другого скрипта ( например активируемого триггером ) примерно так:
</p>

<p>
<code>RPD.Dungeon.level:addScriptedActor(RPD.new(RPD.Objects.Actors.ScriptedActor,«scripts/actors/Burn»))</code>
</p>

<p>
А вот и пример <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/actors/Burn.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/actors/Burn.lua">scripts/actors/Burn.lua</a>
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u0410\u043a\u0442\u043e\u0440\u044b&quot;,&quot;hid&quot;:&quot;\u0430\u043a\u0442\u043e\u0440\u044b&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:3,&quot;range&quot;:&quot;3039-4570&quot;} -->
<h1 class="sectionedit4" id="мобы">Мобы</h1>
<div class="level1">

<p>
Мобы ( а с ними и NPC ) в обилии населяют город и подземелье.
</p>

<p>
Для некоторых из них ( <a href="https://www.nyrds.net/doku.php?id=ru:rpd:custommob" class="wikilink1" title="ru:rpd:custommob" data-wiki-id="ru:rpd:custommob">для кастомных</a> ) можно задавать скрипты описывающие некоторые события в его жизни. 
</p>

<p>
Сейчас это:
</p>
<ul>
<li class="level1"><div class="li"> Смерть ( пример - <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/Hydra.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/Hydra.lua">Hydra</a> )</div>
</li>
<li class="level1"><div class="li"> Взаимодействие с героем ( пример - <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/Talkie.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/Talkie.lua">Talkie</a> )</div>
</li>
<li class="level1"><div class="li"> Добавление моба на уровень (spawn)</div>
</li>
<li class="level1"><div class="li"> Получение урона</div>
</li>
<li class="level1"><div class="li"> Перемещение моба (move) - (пример - <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/NatureAura.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/NatureAura.lua">NatureAura</a>)</div>
</li>
<li class="level1"><div class="li"> Задание характеристик (stats) (пример - <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/NatureAura.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/mobs/NatureAura.lua">NatureAura</a>)</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u041c\u043e\u0431\u044b&quot;,&quot;hid&quot;:&quot;\u043c\u043e\u0431\u044b&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:4,&quot;range&quot;:&quot;4571-5750&quot;} -->
<h1 class="sectionedit5" id="библиотеки">Библиотеки</h1>
<div class="level1">

<p>
В этом разделе будут описаны встроенные библиотеки облегчающие жизнь мододела
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u0411\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0438&quot;,&quot;hid&quot;:&quot;\u0431\u0438\u0431\u043b\u0438\u043e\u0442\u0435\u043a\u0438&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:5,&quot;range&quot;:&quot;5751-5933&quot;} -->
<h2 class="sectionedit6" id="commonclasses">CommonClasses</h2>
<div class="level2">

<p>
Модуль <code>scripts/lib/commonClasses</code> - содержит в себе объект RPD, а в нем привязки и id java классов, доступ к которым нам понадобится. Причём RPD.Objects содержит классы экземпляры которых можно создавать с помощью метода RPD.new
</p>

<p>
Например: <code>local msgWnd = RPD.new(RPD.Objects.Ui.WndMessage,«Message Text»)</code>
</p>

<p>
Остальные элементы RPD содержат привязки классов которые интересны для скриптов только статическими методами и/или  членами.
</p>

<p>
Списки некоторых классов приведены ниже:
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;CommonClasses&quot;,&quot;hid&quot;:&quot;commonclasses&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:6,&quot;range&quot;:&quot;5934-6727&quot;} -->
<h3 class="sectionedit7" id="основные_классы_rpd">Основные классы RPD</h3>
<div class="level3">

<p>
Общий список доступных для lua классов можно увидеть по <a href="https://nyrds.github.io/RemixedDocs/" class="urlextern" title="https://nyrds.github.io/RemixedDocs/">ссылке</a>
</p>

</div>

<h4 id="блобы">Блобы</h4>
<div class="level4">

<p>
Блобы - это жидкости, газы и что-то непонятное что можно выставить на карту вызовом:
</p>

<p>
<code>RPD.Blobs.Blob:seed(cell,amount, blob )</code> - где cell - куда, amount сколько, а blob - класс блоба.
</p>

<p>
Где оно будет (или нет) как-то взаимодействовать с героем, мобами или с другими блобами.
</p>

<p>
Список блобов:
</p>
<ul>
<li class="level1"><div class="li"> Fire</div>
</li>
<li class="level1"><div class="li"> Foliage </div>
</li>
<li class="level1"><div class="li"> ConfusionGas</div>
</li>
<li class="level1"><div class="li"> LiquidFlame</div>
</li>
<li class="level1"><div class="li"> ParalyticGas</div>
</li>
<li class="level1"><div class="li"> Darkness</div>
</li>
<li class="level1"><div class="li"> Web</div>
</li>
<li class="level1"><div class="li"> ToxicGas</div>
</li>
<li class="level1"><div class="li"> Regrowth</div>
</li>
</ul>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;\u041e\u0441\u043d\u043e\u0432\u043d\u044b\u0435 \u043a\u043b\u0430\u0441\u0441\u044b RPD&quot;,&quot;hid&quot;:&quot;\u043e\u0441\u043d\u043e\u0432\u043d\u044b\u0435_\u043a\u043b\u0430\u0441\u0441\u044b_rpd&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:7,&quot;range&quot;:&quot;6728-7535&quot;} -->
<h2 class="sectionedit8" id="storage">Storage</h2>
<div class="level2">

<p>
Модуль <code>scripts/lib/storage</code> позволяет сохранять данные привязанные к уровню, или же игровой сессии в целом. 
</p>

<p>
Для этого он предоставляет 4 метода:
</p>
<ul>
<li class="level1"><div class="li"> <code>put(ключ, значение)</code> - сохраняет значение для текущего уровня</div>
</li>
<li class="level1"><div class="li"> <code>gamePut(ключ, значение)</code>  - сохраняет значение для игровой сессии</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> <code>get(ключ)</code> - возвращает ранее сохранённое значение для текущего уровня</div>
</li>
<li class="level1"><div class="li"> <code>gameGet(ключ)</code> - возвращает ранее сохранённое значение для игровой сессии</div>
</li>
</ul>

<p>
Ключом - может быть строка или число, значением же строка, число или же таблица
</p>

<p>
Данные сохраняются в тех же файлах что и сейвы, а значит подчиняются всем правилам связанным классами и модами. Для сериализации/десериализации сейчас используется библиотека <a href="https://github.com/pkulchenko/serpent" class="urlextern" title="https://github.com/pkulchenko/serpent">serpent</a>
</p>

<p>
В качестве примера давайте рассмотрим <a href="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/traps/Counter.lua" class="urlextern" title="https://github.com/NYRDS/remixed-dungeon/blob/master/RemixedDungeon/src/main/assets/scripts/traps/Counter.lua">ловушку</a>, которая считает сколько на неё раз наступили и показывает соответствующий текст.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Storage&quot;,&quot;hid&quot;:&quot;storage&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:8,&quot;range&quot;:&quot;7536-9181&quot;} -->
<h2 class="sectionedit9" id="quest">Quest</h2>
<div class="level2">

<p>
Модуль <code>scripts/lib/quest</code> существует для облегчения подготовки квестов.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Quest&quot;,&quot;hid&quot;:&quot;quest&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:9,&quot;range&quot;:&quot;9182-9322&quot;} -->
<h2 class="sectionedit10" id="mob">Mob</h2>
<div class="level2">

<p>
Модуль <code>scripts/lib/mob</code> содержит методы позволяющие создавать собственных мобов.
</p>

</div>
<!-- EDIT{&quot;target&quot;:&quot;section&quot;,&quot;name&quot;:&quot;Mob&quot;,&quot;hid&quot;:&quot;mob&quot;,&quot;codeblockOffset&quot;:0,&quot;secid&quot;:10,&quot;range&quot;:&quot;9323-&quot;} -->